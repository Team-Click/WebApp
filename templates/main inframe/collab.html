<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>시간표 협업 기능</title>
  <style>
    @font-face {
      font-family: 'SMUSnowflake-Bold';
      src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/2409-2@1.0/SMUSnowflake-Bold.woff2') format('woff2');
      font-weight: 700;
      font-style: normal;
    }

    @font-face {
      font-family: 'SMUSnowflake-Regular';
      src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/2409-2@1.0/SMUSnowflake-Regular.woff2') format('woff2');
      font-weight: 400;
      font-style: normal;
    }

    /* 공통 레이아웃 */

    html {
      overflow-y: scroll;
      /* 세로 스크롤 바 항상 표시 */
    }

    body {
      margin: 0;
    }

    #container {
      justify-content: center;
      justify-content: space-around;
      display: flex;
      width: 100%;
      align-items: flex-start;
      /* 각 요소가 위쪽에 정렬되고 고유 높이를 유지 */
    }

    #friend-list {
      text-align: center;
      margin: 50px;
      padding: 10px;
      width: 20%;
      border: 1px solid #ffffff;
      box-shadow: 3px 3px 5px #ddd,
        0 0 5px #ddd;
    }

    #schedule-container {
      margin: auto;
      display: block;
      width: 80%;
      padding: 20px;
    }

    h2 {
      font-family: 'SMUSnowflake-Bold', Arial, sans-serif;
      color: #b93234;
    }

    h1 {
      text-align: center;
      margin-top: 30px;
      font-family: 'SMUSnowflake-Bold', Arial, sans-serif;
      font-size: 50px;
    }

    /* 친구 목록 스타일 */
    .friend-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .friend-buttons button {
      width: 40%;
      padding: 10px;
      font-family: 'SMUSnowflake-Regular', Arial, sans-serif;
      background-color: #f4f4f4;
      border: 1px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      color: black;
    }

    .friend-buttons button.selected {
      background-color: #b93234;
      color: white;
    }

    .friend-buttons button.selected:hover {
      background-color: #a12b2d;
      color: white;
    }

    .friend-buttons button:hover {
      background-color: #e0e0e0;
      color: black;
    }

    .search-container {
      margin-bottom: 20px;
    }

    .search-container input {
      width: 93%;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    /* 시간표 스타일 */
    #schedule-table-container {
      width: 80%;
    }

    .schedule-table {
      font-family: Arial, sans-serif;
      margin: auto;
      margin-top: 40px;
      margin-bottom: 50px;
      width: 90%;
      border-collapse: collapse;
      table-layout: fixed;
      border-radius: 20px;
      overflow: hidden;
      border: 1px solid #b93234;
      box-shadow: 3px 3px 5px #ddd,
        0 0 3px #ddd,
        0 0 3px #ddd;
    }

    .schedule-table td {
      border: 1px solid #ddd;
      text-align: center;
      height: 30px;
      padding: 5px;
      font-size: 13px;
      word-wrap: break-word;
    }

    .schedule-table th {
      border: 1px solid #ddd;
      text-align: center;
      padding: 1%;
      height: 30px;
      font-size: 15px;
      word-wrap: break-word;
    }

    .schedule-table td.free {
      background-color: #c3f0c8;
      /* 연두색 */
    }

    .schedule-table td.busy {
      background-color: #f5c6cb;
      /* 연한 분홍색 */
    }

    button {
      padding: 10px;
      background-color: #b93234;
      color: white;
      border: none;
      border-radius: 5px;
      font-family: 'SMUSnowflake-Regular', Arial, sans-serif;
      cursor: pointer;
    }

    button:hover {
      background-color: #a12b2d;
    }

    #start {
      margin: 20px;
    }

    /* 모바일 스타일 */
    @media screen and (max-width: 768px) {
      h1 {
        font-size: 28px;
        /* 제목 크기 축소 */
        margin-top: 20px;
      }

      #container {
        flex-direction: column;
        /* 친구 목록과 시간표를 세로로 배치 */
        align-items: center;
      }

      #friend-list {
        width: 85%;
        /* 너비 확장 */
        margin-bottom: 20px;
        /* 아래쪽 여백 추가 */
      }

      .friend-buttons button {
        width: 100%;
        /* 버튼이 전체 너비를 차지 */
        font-size: 14px;
        /* 글자 크기 축소 */
        padding: 10px;
        /* 버튼 패딩 조정 */
      }

      .search-container input {
        width: 93%;
        /* 검색창이 친구 목록 너비에 맞게 조정 */
        font-size: 14px;
      }

      #schedule-table-container {
        width: 90%;
        /* 시간표 컨테이너 너비 조정 */
      }

      .schedule-table {
        font-size: 12px;
        /* 테이블 글자 크기 축소 */
        width: 100%;
        /* 테이블이 화면 너비에 맞게 조정 */
        border-radius: 10px;
        /* 둥근 모서리 조정 */
      }

      .schedule-table th,
      .schedule-table td {
        padding: 5px;
        /* 셀 패딩 축소 */
        height: 25px;
        /* 셀 높이 축소 */
      }

      .schedule-table th:first-child {
        background-color: #b93234;
        /* '시간' 셀 배경 유지 */
        color: white;
      }

      button {
        width: 100%;
        /* 버튼이 화면 너비에 맞도록 조정 */
        font-size: 14px;
        /* 버튼 글자 크기 축소 */
        padding: 8px 10px;
        /* 패딩 축소 */
      }

      #friendSearch {
        margin-bottom: 10px;
      }

      #start {
        margin: 0;
        margin-top: 20px;
      }
    }
  </style>
</head>

<body>
  <div id="schedule-container">
    <h1>학생 공통 빈 시간대 조회</h1>
    <hr style="width: 70%; margin-top: 0;">
  </div>

  <div id="container">
    <div id="friend-list">
      <h2>친구 목록</h2>
      <div class="search-container">
        <input type="text" id="friendSearch" placeholder="친구 이름 검색..." oninput="filterFriends()">
      </div>
      <div class="friend-buttons" id="friendButtons">
        
      </div>
      <button id="start" onclick="findCommonFreeTime()">공통 빈 시간대 찾기</button>
    </div>

    <div id="schedule-table-container"></div>
  </div>

  <script>
    const selectedStudents = new Set();

    // 페이지 로드 시 친구 목록 불러오기
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const userId = localStorage.getItem("userId");
        if (!userId) throw new Error("로그인된 사용자 ID가 없습니다.");

        //const response = await fetch("http://127.0.0.1:5001/get_friends", {
        const response = await fetch("https://login-juko.onrender.com/get_friends", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ id: userId }),
        });

        if (!response.ok) throw new Error("친구 목록 가져오기 실패");
        const data = await response.json();

        if (data.status !== "success") throw new Error(data.message);

        renderFriendButtons(data.friends);
      } catch (error) {
        console.error("친구 목록 로드 실패:", error.message);
      }
    });

    // 친구 목록 버튼 생성
    function renderFriendButtons(friends) {
      const friendButtonsContainer = document.getElementById("friendButtons");
      friendButtonsContainer.innerHTML = "";

      const userId = localStorage.getItem("userId");
      const userName = localStorage.getItem("userName");
      if (userId && userName) {
        const userButton = document.createElement("button");
        userButton.textContent = userName; // 사용자 이름 표시
        userButton.onclick = () => toggleSelection(userButton, userId); // ID로 작동
        friendButtonsContainer.appendChild(userButton);
      }

      friends.forEach((friend) => {
        const button = document.createElement("button");
        button.textContent = friend.friend_name;
        button.onclick = () => toggleSelection(button, friend.friend_id);
        friendButtonsContainer.appendChild(button);
      });
    }

    // 친구 선택 토글
    function toggleSelection(button, friendId) {
      if (selectedStudents.has(friendId)) {
        selectedStudents.delete(friendId);
        button.classList.remove("selected");
      } else {
        selectedStudents.add(friendId);
        button.classList.add("selected");
      }
    }

    // 공통 빈 시간대 찾기
    async function findCommonFreeTime() {
      const selectedFriendIds = Array.from(selectedStudents);

      if (selectedFriendIds.length === 0) {
        alert("한 명 이상의 친구를 선택해주세요.");
        return;
      }

      const studentSchedules = [];
      for (const friendId of selectedFriendIds) {
        try {
          //const response = await fetch("http://127.0.0.1:5001/get_timetable", {
          const response = await fetch("https://login-juko.onrender.com/get_timetable", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ id: friendId }),
          });

          if (!response.ok) {
            console.error(`Failed to fetch schedule for friend ID ${friendId}`);
            continue;
          }

          const data = await response.json();
          if (data.status !== "success") {
            console.error(`Error in response for friend ID ${friendId}:`, data.message);
            continue;
          }

          studentSchedules.push(data.timetable);
        } catch (error) {
          console.error(`Error fetching schedule for friend ID ${friendId}:`, error.message);
        }
      }

      if (studentSchedules.length === 0) {
        alert("친구 시간표를 불러올 수 없습니다.");
        return;
      }

      let commonFreeTimes = Array(5)
        .fill(null)
        .map(() => Array(30).fill(true));

      studentSchedules.forEach((schedule) => {
        const freeTimes = getFreeTimeForStudent(schedule.schedule);
        commonFreeTimes = commonFreeTimes.map((day, dayIndex) =>
          day.map((time, timeIndex) => time && freeTimes[dayIndex][timeIndex])
        );
      });

      displayScheduleTable(commonFreeTimes);

      const scheduleContainer = document.getElementById("schedule-table-container");
      scheduleContainer.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    // 학생의 자유시간표 계산
    function getFreeTimeForStudent(schedule) {
  const freeTimes = Array(5).fill(null).map(() => Array(30).fill(true));

  schedule.forEach(({ day, start_time, end_time }) => {
    const startTime = parseTime(start_time);
    const endTime = parseTime(end_time);

    for (let time = startTime; time < endTime; time += 30) {
      const timeSlot = (time - 540) / 30;
      if (timeSlot >= 0 && timeSlot < 30) {
        freeTimes[day - 1][timeSlot] = false;
      }
    }
  });

  return freeTimes;
}

    // 시간 문자열을 분 단위로 변환
    function parseTime(timeStr) {
      const [hours, minutes] = timeStr.split(":").map(Number);
      return hours * 60 + minutes;
    }

    // 시간표 출력
    function displayScheduleTable(freeTimes) {
      const container = document.getElementById("schedule-table-container");
      container.innerHTML = "";

      const table = document.createElement("table");
      table.className = "schedule-table";

      // 제목행 생성
      const headerRow = document.createElement("tr");
      const days = ["시간", "월", "화", "수", "목", "금"];
      days.forEach((day) => {
        const th = document.createElement("th");
        th.textContent = day;
        th.style.backgroundColor = "#b93234"; // 1행 배경색 변경
        th.style.color = "white"; // 텍스트 색상을 흰색으로
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);

      // 시간표 행 생성
      for (let minutes = 540; minutes < 1440; minutes += 30) {
        const row = document.createElement("tr");
        const timeCell = document.createElement("th");
        const hour = Math.floor(minutes / 60);
        const minute = minutes % 60;
        timeCell.textContent = `${hour.toString().padStart(2, "0")}:${minute.toString().padStart(2, "0")}`;
        timeCell.style.backgroundColor = "white"; // 시간 열 배경 흰색
        timeCell.style.color = "black"; // 시간 열 글자색 검정
        timeCell.style.fontWeight = "400"; // 폰트 두께를 보통으로 설정
        timeCell.style.fontSize = "13px"; // 글자 크기 조정
        timeCell.style.padding = "5px"; // 시간 셀 패딩
        row.appendChild(timeCell);

        freeTimes.forEach((day) => {
          const timeSlot = (minutes - 540) / 30;
          const cell = document.createElement("td");
          cell.className = day[timeSlot] ? "free" : "busy";
          cell.textContent = day[timeSlot] ? "O" : "X";
          cell.style.padding = "5px"; // 데이터 셀 패딩
          row.appendChild(cell);
        });
        table.appendChild(row);
      }

      container.appendChild(table);
    }
  </script>


</body>

</html>