<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>시간표 협업 기능</title>
  <style>
    @font-face {
      font-family: 'SMUSnowflake-Bold';
      src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/2409-2@1.0/SMUSnowflake-Bold.woff2') format('woff2');
      font-weight: 700;
      font-style: normal;
    }

    @font-face {
      font-family: 'SMUSnowflake-Regular';
      src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/2409-2@1.0/SMUSnowflake-Regular.woff2') format('woff2');
      font-weight: 400;
      font-style: normal;
    }

    /* 공통 레이아웃 */

    html {
      overflow-y: scroll;
      /* 세로 스크롤 바 항상 표시 */
    }

    body {
      margin: 0;
    }

    #container {
      justify-content: center;
      justify-content: space-around;
      display: flex;
      width: 100%;
      align-items: flex-start;
      /* 각 요소가 위쪽에 정렬되고 고유 높이를 유지 */
    }

    #friend-list {
      text-align: center;
      margin: 50px;
      padding: 10px;
      width: 20%;
      border: 1px solid #ffffff;
      box-shadow: 3px 3px 5px #ddd,
        0 0 5px #ddd;
    }

    #schedule-container {
      margin: auto;
      display: block;
      width: 80%;
      padding: 20px;
    }

    h2 {
      font-family: 'SMUSnowflake-Bold', Arial, sans-serif;
      color: #b93234;
    }

    h1 {
      text-align: center;
      margin-top: 30px;
      font-family: 'SMUSnowflake-Bold', Arial, sans-serif;
      font-size: 50px;
    }

    /* 친구 목록 스타일 */
    .friend-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .friend-buttons button {
      width: 40%;
      padding: 10px;
      font-family: 'SMUSnowflake-Regular', Arial, sans-serif;
      background-color: #f4f4f4;
      border: 1px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      color: black;
    }

    .friend-buttons button.selected {
      background-color: #b93234;
      color: white;
    }

    .friend-buttons button.selected:hover {
      background-color: #a12b2d;
      color: white;
    }

    .friend-buttons button:hover {
      background-color: #e0e0e0;
      color: black;
    }

    .search-container {
      margin-bottom: 20px;
    }

    .search-container input {
      width: 93%;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    /* 시간표 스타일 */
    #schedule-table-container {
      width: 80%;
    }

    .schedule-table {
      font-family: Arial, sans-serif;
      margin: auto;
      margin-top: 40px;
      margin-bottom: 50px;
      width: 90%;
      border-collapse: collapse;
      table-layout: fixed;
      border-radius: 20px;
      overflow: hidden;
      border: 1px solid #b93234;
      box-shadow: 3px 3px 5px #ddd,
        0 0 3px #ddd,
        0 0 3px #ddd;
    }

    .schedule-table td {
      border: 1px solid #ddd;
      text-align: center;
      height: 30px;
      padding: 5px;
      font-size: 13px;
      word-wrap: break-word;
    }

    .schedule-table th {
      border: 1px solid #ddd;
      text-align: center;
      padding: 1%;
      height: 30px;
      font-size: 15px;
      word-wrap: break-word;
    }

    .schedule-table td.free {
      background-color: #c3f0c8;
      /* 연두색 */
    }

    .schedule-table td.busy {
      background-color: #f5c6cb;
      /* 연한 분홍색 */
    }

    button {
      padding: 10px;
      background-color: #b93234;
      color: white;
      border: none;
      border-radius: 5px;
      font-family: 'SMUSnowflake-Regular', Arial, sans-serif;
      cursor: pointer;
    }

    button:hover {
      background-color: #a12b2d;
    }

    #start {
      margin: 20px;
    }

    /* 모바일 스타일 */
    @media screen and (max-width: 768px) {
      h1 {
        font-size: 28px;
        /* 제목 크기 축소 */
        margin-top: 20px;
      }

      #container {
        flex-direction: column;
        /* 친구 목록과 시간표를 세로로 배치 */
        align-items: center;
      }

      #friend-list {
        width: 85%;
        /* 너비 확장 */
        margin-bottom: 20px;
        /* 아래쪽 여백 추가 */
      }

      .friend-buttons button {
        width: 100%;
        /* 버튼이 전체 너비를 차지 */
        font-size: 14px;
        /* 글자 크기 축소 */
        padding: 10px;
        /* 버튼 패딩 조정 */
      }

      .search-container input {
        width: 93%;
        /* 검색창이 친구 목록 너비에 맞게 조정 */
        font-size: 14px;
      }

      #schedule-table-container {
        width: 90%;
        /* 시간표 컨테이너 너비 조정 */
      }

      .schedule-table {
        font-size: 12px;
        /* 테이블 글자 크기 축소 */
        width: 100%;
        /* 테이블이 화면 너비에 맞게 조정 */
        border-radius: 10px;
        /* 둥근 모서리 조정 */
      }

      .schedule-table th,
      .schedule-table td {
        padding: 5px;
        /* 셀 패딩 축소 */
        height: 25px;
        /* 셀 높이 축소 */
      }

      .schedule-table th:first-child {
        background-color: #b93234;
        /* '시간' 셀 배경 유지 */
        color: white;
      }

      button {
        width: 100%;
        /* 버튼이 화면 너비에 맞도록 조정 */
        font-size: 14px;
        /* 버튼 글자 크기 축소 */
        padding: 8px 10px;
        /* 패딩 축소 */
      }

      #friendSearch {
        margin-bottom: 10px;
      }

      #start {
      margin: 0;
      margin-top: 20px;
    }
    }
  </style>
</head>

<body>
  <div id="schedule-container">
    <h1>학생 공통 빈 시간대 조회</h1>
    <hr style="width: 70%; margin-top: 0;">
  </div>

  <div id="container">
    <div id="friend-list">
      <h2>친구 목록</h2>
      <div class="search-container">
        <input type="text" id="friendSearch" placeholder="친구 이름 검색..." oninput="filterFriends()">
      </div>
      <div class="friend-buttons" id="friendButtons">
        <button onclick="toggleSelection(this, '23011898_이헌성')">이헌성</button>
        <button onclick="toggleSelection(this, '23011927_김태경')">김태경</button>
        <button onclick="toggleSelection(this, '22011925_권효정')">권효정</button>
        <button onclick="toggleSelection(this, '23011881_김하연')">김하연</button>
      </div>
      <button id="start" onclick="findCommonFreeTime()">공통 빈 시간대 찾기</button>
    </div>

    <div id="schedule-table-container"></div>
  </div>

  <script>
    const selectedStudents = new Set();

    function toggleSelection(button, studentInfo) {
      if (selectedStudents.has(studentInfo)) {
        selectedStudents.delete(studentInfo);
        button.classList.remove('selected');
      } else {
        selectedStudents.add(studentInfo);
        button.classList.add('selected');
      }
    }

    function filterFriends() {
      const searchInput = document.getElementById('friendSearch').value.toLowerCase();
      const buttons = document.getElementById('friendButtons').getElementsByTagName('button');

      for (let button of buttons) {
        const name = button.textContent.toLowerCase();
        button.style.display = name.includes(searchInput) ? 'block' : 'none';
      }
    }

    async function findCommonFreeTime() {
      const selectedStudentInfos = Array.from(selectedStudents);

      if (selectedStudentInfos.length === 0) {
        alert("한 명 이상의 친구를 선택해주세요.");
        return;
      }

      const studentSchedules = [];
      for (const studentInfo of selectedStudentInfos) {
        const [number, name] = studentInfo.split('_');
        const filePath = `../../asset/json/${number}_${name}.json`;
        try {
          const response = await fetch(filePath);
          if (!response.ok) {
            console.error(`Failed to fetch schedule for ${name}`);
            continue;
          }
          const studentData = await response.json();
          studentSchedules.push(studentData);
        } catch (error) {
          console.error(`Error fetching schedule for ${name}:`, error);
        }
      }

      if (studentSchedules.length === 0) {
        alert("일치하는 친구가 없습니다.");
        return;
      }

      let commonFreeTimes = Array(5).fill(null).map(() => Array(30).fill(true));
      studentSchedules.forEach(student => {
        const freeTimes = getFreeTimeForStudent(student.schedule);
        commonFreeTimes = commonFreeTimes.map((day, dayIndex) =>
          day.map((time, timeIndex) => time && freeTimes[dayIndex][timeIndex])
        );
      });

      displayScheduleTable(commonFreeTimes);

      // 스크롤 이동 추가
      const scheduleContainer = document.getElementById('schedule-table-container');
      scheduleContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }


    function getFreeTimeForStudent(schedule) {
      const freeTimes = Array(5).fill(null).map(() => Array(30).fill(true));

      schedule.forEach(({ class_days, start_time, end_time }) => {
        const startTime = parseTime(start_time);
        const endTime = parseTime(end_time);
        class_days.forEach(day => {
          for (let time = startTime; time < endTime; time += 30) {
            const timeSlot = (time - 540) / 30; // Adjusted for 9:00 (540 minutes) start
            if (timeSlot >= 0 && timeSlot < 30) {
              freeTimes[day - 1][timeSlot] = false;
            }
          }
        });
      });

      return freeTimes;
    }

    function parseTime(timeStr) {
      const [hours, minutes] = timeStr.split(':').map(Number);
      return hours * 60 + minutes;
    }

    function displayScheduleTable(freeTimes) {
  const container = document.getElementById('schedule-table-container');
  container.innerHTML = '';

  const table = document.createElement('table');
  table.className = 'schedule-table';

  // 제목행 생성
  const headerRow = document.createElement('tr');
  const days = ["시간", "월", "화", "수", "목", "금"];
  days.forEach((day, index) => {
    const th = document.createElement('th');
    th.textContent = day;
    if (index === 0) {
      th.style.backgroundColor = '#b93234'; // 붉은색 배경
      th.style.color = 'white'; // 흰색 글자
    } else {
      th.style.backgroundColor = '#b93234'; // 다른 요일 배경색 유지
      th.style.color = 'white';
    }
    th.style.padding = '10px'; // 제목행 패딩
    headerRow.appendChild(th);
  });
  table.appendChild(headerRow);

  // 시간표 행 생성
  for (let minutes = 540; minutes < 1440; minutes += 30) {
    const row = document.createElement('tr');
    const timeCell = document.createElement('th');
    const hour = Math.floor(minutes / 60);
    const minute = minutes % 60;
    timeCell.textContent = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
    timeCell.style.backgroundColor = 'white'; // 시간 열 배경 흰색
    timeCell.style.color = 'black'; // 시간 열 글자색 검정
    timeCell.style.fontWeight = '400'; // 폰트 두께를 보통으로 설정
    timeCell.style.fontSize = '13px'; // 글자 크기 조정
    timeCell.style.padding = '5px'; // 시간 셀 패딩
    row.appendChild(timeCell);

    freeTimes.forEach(day => {
      const timeSlot = (minutes - 540) / 30;
      const cell = document.createElement('td');
      cell.className = day[timeSlot] ? 'free' : 'busy';
      cell.textContent = day[timeSlot] ? 'O' : 'X';
      cell.style.padding = '5px'; // 데이터 셀 패딩
      row.appendChild(cell);
    });
    table.appendChild(row);
  }

  container.appendChild(table);
} 
  </script>
</body>

</html>