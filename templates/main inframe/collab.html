<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>시간표 협업 기능</title>
  <style>
    @font-face {
      font-family: 'SMUSnowflake-Bold';
      src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/2409-2@1.0/SMUSnowflake-Bold.woff2') format('woff2');
      font-weight: 700;
      font-style: normal;
    }

    @font-face {
      font-family: 'SMUSnowflake-Regular';
      src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/2409-2@1.0/SMUSnowflake-Regular.woff2') format('woff2');
      font-weight: 400;
      font-style: normal;
    }

    /* 공통 레이아웃 */

    html {
      overflow-y: scroll;
      /* 세로 스크롤 바 항상 표시 */
    }

    body {
      margin: 0;
      font-family: 'Arial', sans-serif;
    }

    #container {
      justify-content: center;
      justify-content: space-around;
      display: flex;
      width: 100%;
      align-items: flex-start;
      /* 각 요소가 위쪽에 정렬되고 고유 높이를 유지 */
    }

    #friend-list {
      text-align: center;
      margin: 50px;
      padding: 10px;
      width: 20%;
      border: 1px solid #ffffff;
      box-shadow: 3px 3px 5px #ddd,
        0 0 5px #ddd;
    }

    #schedule-container {
      margin: auto;
      display: block;
      width: 80%;
      padding: 20px;
    }

    h2 {
      font-family: 'SMUSnowflake-Bold', Arial, sans-serif;
      color: #b93234;
    }

    h1 {
      text-align: center;
      margin-top: 30px;
      font-family: 'SMUSnowflake-Bold', Arial, sans-serif;
      font-size: 50px;
    }

    /* 친구 목록 스타일 */
    .friend-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .friend-buttons button {
      width: 40%;
      padding: 10px;
      font-family: 'SMUSnowflake-Regular', Arial, sans-serif;
      background-color: #f4f4f4;
      border: 1px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      color: black;
    }

    .friend-buttons button.selected {
      background-color: #b93234;
      color: white;
    }

    .friend-buttons button:hover {
      background-color: #e0e0e0;
      color: black;
    }

    .search-container {
      margin-bottom: 20px;
    }

    .search-container input {
      width: 93%;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    /* 시간표 스타일 */
    #schedule-table-container {
      width: 80%;
    }

    .schedule-table {
      margin: auto;
      margin-top: 40px;
      margin-bottom: 50px;
      width: 90%;
      border-collapse: collapse;
      table-layout: fixed;
      border-radius: 20px;
      overflow: hidden;
      border: 1px solid #ffffff;
      box-shadow: 3px 3px 5px #ddd,
                  0 0 3px #ddd,
                  0 0 3px #ddd;
    }

    .schedule-table th,
    .schedule-table td {
      border: 1px solid #ddd;
      text-align: center;
      padding: 5px;
      height: 30px;
      font-size: 13px;
      word-wrap: break-word;
    }

    .schedule-table th {
      font-size: 15px;
      background-color: #b93234;
      color: white;
    }

    .schedule-table td.free {
      background-color: #c3f0c8;
      /* 연두색 */
    }

    .schedule-table td.busy {
      background-color: #f5c6cb;
      /* 연한 분홍색 */
    }

    button {
      padding: 10px;
      background-color: #b93234;
      color: white;
      border: none;
      border-radius: 5px;
      font-family: 'SMUSnowflake-Regular', Arial, sans-serif;
      cursor: pointer;
    }

    button:hover {
      background-color: #a12b2d;
    }
  </style>
</head>

<body>
  <div id="schedule-container">
    <h1>학생 공통 빈 시간대 조회</h1>
    <hr style="width: 70%; margin-top: 0;">
  </div>

  <div id="container">
    <div id="friend-list">
      <h2>친구 목록</h2>
      <div class="search-container">
        <input type="text" id="friendSearch" placeholder="친구 이름 검색..." oninput="filterFriends()">
      </div>
      <div class="friend-buttons" id="friendButtons">
        <button onclick="toggleSelection(this, '23011898_이헌성')">이헌성</button>
        <button onclick="toggleSelection(this, '23011927_김태경')">김태경</button>
        <button onclick="toggleSelection(this, '22011925_권효정')">권효정</button>
        <button onclick="toggleSelection(this, '23011881_김하연')">김하연</button>
      </div>
      <button onclick="findCommonFreeTime()" style="margin: 20px;">공통 빈 시간대 찾기</button>
    </div>

    <div id="schedule-table-container"></div>
  </div>

  <script>
    const selectedStudents = new Set();

    function toggleSelection(button, studentInfo) {
      if (selectedStudents.has(studentInfo)) {
        selectedStudents.delete(studentInfo);
        button.classList.remove('selected');
      } else {
        selectedStudents.add(studentInfo);
        button.classList.add('selected');
      }
    }

    function filterFriends() {
      const searchInput = document.getElementById('friendSearch').value.toLowerCase();
      const buttons = document.getElementById('friendButtons').getElementsByTagName('button');

      for (let button of buttons) {
        const name = button.textContent.toLowerCase();
        button.style.display = name.includes(searchInput) ? 'block' : 'none';
      }
    }

    async function findCommonFreeTime() {
      const selectedStudentInfos = Array.from(selectedStudents);

      if (selectedStudentInfos.length === 0) {
        alert("한 명 이상의 친구를 선택해주세요.");
        return;
      }

      const studentSchedules = [];
      for (const studentInfo of selectedStudentInfos) {
        const [number, name] = studentInfo.split('_');
        const filePath = `../../asset/json/${number}_${name}.json`;
        try {
          const response = await fetch(filePath);
          if (!response.ok) {
            console.error(`Failed to fetch schedule for ${name}`);
            continue;
          }
          const studentData = await response.json();
          studentSchedules.push(studentData);
        } catch (error) {
          console.error(`Error fetching schedule for ${name}:`, error);
        }
      }

      if (studentSchedules.length === 0) {
        alert("일치하는 친구가 없습니다.");
        return;
      }

      let commonFreeTimes = Array(5).fill(null).map(() => Array(30).fill(true));
      studentSchedules.forEach(student => {
        const freeTimes = getFreeTimeForStudent(student.schedule);
        commonFreeTimes = commonFreeTimes.map((day, dayIndex) =>
          day.map((time, timeIndex) => time && freeTimes[dayIndex][timeIndex])
        );
      });

      displayScheduleTable(commonFreeTimes);
    }

    function getFreeTimeForStudent(schedule) {
      const freeTimes = Array(5).fill(null).map(() => Array(30).fill(true));

      schedule.forEach(({ class_days, start_time, end_time }) => {
        const startTime = parseTime(start_time);
        const endTime = parseTime(end_time);
        class_days.forEach(day => {
          for (let time = startTime; time < endTime; time += 30) {
            const timeSlot = (time - 540) / 30; // Adjusted for 9:00 (540 minutes) start
            if (timeSlot >= 0 && timeSlot < 30) {
              freeTimes[day - 1][timeSlot] = false;
            }
          }
        });
      });

      return freeTimes;
    }

    function parseTime(timeStr) {
      const [hours, minutes] = timeStr.split(':').map(Number);
      return hours * 60 + minutes;
    }

    function displayScheduleTable(freeTimes) {
      const container = document.getElementById('schedule-table-container');
      container.innerHTML = '';

      const table = document.createElement('table');
      table.className = 'schedule-table';

      const headerRow = document.createElement('tr');
      const days = ["시간", "월요일", "화요일", "수요일", "목요일", "금요일"];
      days.forEach((day, index) => {
        const th = document.createElement('th');
        th.textContent = day;
        if (index === 0) {
          th.style.backgroundColor = '#b93234'; // 붉은색 배경
          th.style.color = 'white'; // 흰색 글자
        } else {
          th.style.backgroundColor = '#b93234'; // 다른 요일 배경색 유지
          th.style.color = 'white';
        }
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);

      for (let minutes = 540; minutes < 1440; minutes += 30) {
        const row = document.createElement('tr');
        const timeCell = document.createElement('th');
        const hour = Math.floor(minutes / 60);
        const minute = minutes % 60;
        timeCell.textContent = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
        timeCell.style.backgroundColor = 'white'; // 시간 열 배경 흰색
        timeCell.style.color = 'black'; // 시간 열 글자색 검정
        row.appendChild(timeCell);

        freeTimes.forEach(day => {
          const timeSlot = (minutes - 540) / 30;
          const cell = document.createElement('td');
          cell.className = day[timeSlot] ? 'free' : 'busy';
          cell.textContent = day[timeSlot] ? 'O' : 'X';
          row.appendChild(cell);
        });
        table.appendChild(row);
      }

      container.appendChild(table);
    }
  </script>
</body>

</html>